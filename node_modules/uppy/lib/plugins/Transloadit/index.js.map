{"version":3,"sources":["../../../src/plugins/Transloadit/index.js"],"names":["Translator","require","Plugin","Client","StatusSocket","defaultGetAssemblyOptions","file","options","params","signature","fields","module","exports","uppy","opts","type","id","title","defaultLocale","strings","creatingAssembly","creatingAssemblyFailed","encoding","defaultOptions","waitForEncoding","waitForMetadata","alwaysRunAssembly","importFromUploadURLs","getAssemblyOptions","locale","translator","i18n","translate","bind","prepareUpload","afterUpload","onFileUploadURLAvailable","onRestored","getPersistentData","validateParams","client","sockets","Error","JSON","parse","err","message","auth","key","fileIDs","all","map","fileID","getFile","promise","resolve","then","assemblyOptions","dedupeAssemblyOptions","list","dedupeMap","Object","create","forEach","stringify","push","keys","createAssembly","uploadID","pluginOptions","log","expectedFiles","length","assembly","state","getPluginState","assemblyList","uploadsAssemblies","concat","assembly_id","setPluginState","assemblies","attachAssemblyMetadata","tlMeta","assembly_url","filename","name","fieldname","meta","tus","endpoint","tus_url","metaFields","uploadUrl","resume","remote","newHost","uppyserver_url","endsWith","slice","path","url","replace","host","startsWith","transloadit","newFile","files","setState","emit","connectSocket","catch","info","shouldWait","reserveFiles","reserveFile","addFile","findFile","uploadedFile","hasOwnProperty","uploadURL","tus_upload_url","is_tus_file","size","onFileUploadComplete","assemblyId","getAssembly","onResult","stepName","result","original_id","localId","entry","results","onAssemblyFinished","getAssemblyStatus","setData","uploads","emitEventsDiff","prevState","emitMissedEvents","newUploads","filter","newResults","some","prev","newAssemblies","previousAssemblies","oldAssembly","diffAssemblyStatus","next","ok","upload_meta_data_extracted","error","pluginData","savedState","knownUploads","knownResults","loadAssemblies","assemblyIDs","assemblyID","reconnectSockets","restoreState","assembliesById","restored","newState","previousFiles","indexOf","socket","websocket_url","on","assembly_ssl_url","reject","mode","optionsPromise","allOptions","close","addResultData","finishedAssemblies","getAssemblyFiles","checkAllComplete","onAssemblyError","onImportError","removeListeners","off","install","addPreProcessor","addPostProcessor","uninstall","removePreProcessor","removePostProcessor"],"mappings":"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","file":"index.js","sourcesContent":["const Translator = require('../../core/Translator')\nconst Plugin = require('../../core/Plugin')\nconst Client = require('./Client')\nconst StatusSocket = require('./Socket')\n\nfunction defaultGetAssemblyOptions (file, options) {\n  return {\n    params: options.params,\n    signature: options.signature,\n    fields: options.fields\n  }\n}\n\n/**\n * Upload files to Transloadit using Tus.\n */\nmodule.exports = class Transloadit extends Plugin {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = 'Transloadit'\n    this.title = 'Transloadit'\n\n    const defaultLocale = {\n      strings: {\n        creatingAssembly: 'Preparing upload...',\n        creatingAssemblyFailed: 'Transloadit: Could not create assembly',\n        encoding: 'Encoding...'\n      }\n    }\n\n    const defaultOptions = {\n      waitForEncoding: false,\n      waitForMetadata: false,\n      alwaysRunAssembly: false,\n      importFromUploadURLs: false,\n      signature: null,\n      params: null,\n      fields: {},\n      getAssemblyOptions: defaultGetAssemblyOptions,\n      locale: defaultLocale\n    }\n\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\n\n    this.translator = new Translator({ locale: this.locale })\n    this.i18n = this.translator.translate.bind(this.translator)\n\n    this.prepareUpload = this.prepareUpload.bind(this)\n    this.afterUpload = this.afterUpload.bind(this)\n    this.onFileUploadURLAvailable = this.onFileUploadURLAvailable.bind(this)\n    this.onRestored = this.onRestored.bind(this)\n    this.getPersistentData = this.getPersistentData.bind(this)\n\n    if (this.opts.params) {\n      this.validateParams(this.opts.params)\n    }\n\n    this.client = new Client()\n    this.sockets = {}\n  }\n\n  validateParams (params) {\n    if (!params) {\n      throw new Error('Transloadit: The `params` option is required.')\n    }\n\n    if (typeof params === 'string') {\n      try {\n        params = JSON.parse(params)\n      } catch (err) {\n        // Tell the user that this is not an Uppy bug!\n        err.message = 'Transloadit: The `params` option is a malformed JSON string: ' +\n          err.message\n        throw err\n      }\n    }\n\n    if (!params.auth || !params.auth.key) {\n      throw new Error('Transloadit: The `params.auth.key` option is required. ' +\n        'You can find your Transloadit API key at https://transloadit.com/accounts/credentials.')\n    }\n  }\n\n  getAssemblyOptions (fileIDs) {\n    const options = this.opts\n    return Promise.all(\n      fileIDs.map((fileID) => {\n        const file = this.uppy.getFile(fileID)\n        const promise = Promise.resolve()\n          .then(() => options.getAssemblyOptions(file, options))\n        return promise.then((assemblyOptions) => {\n          this.validateParams(assemblyOptions.params)\n\n          return {\n            fileIDs: [fileID],\n            options: assemblyOptions\n          }\n        })\n      })\n    )\n  }\n\n  dedupeAssemblyOptions (list) {\n    const dedupeMap = Object.create(null)\n    list.forEach(({ fileIDs, options }) => {\n      const id = JSON.stringify(options)\n      if (dedupeMap[id]) {\n        dedupeMap[id].fileIDs.push(...fileIDs)\n      } else {\n        dedupeMap[id] = {\n          options,\n          fileIDs: [...fileIDs]\n        }\n      }\n    })\n\n    return Object.keys(dedupeMap).map((id) => dedupeMap[id])\n  }\n\n  createAssembly (fileIDs, uploadID, options) {\n    const pluginOptions = this.opts\n\n    this.uppy.log('[Transloadit] create assembly')\n\n    return this.client.createAssembly({\n      params: options.params,\n      fields: options.fields,\n      expectedFiles: fileIDs.length,\n      signature: options.signature\n    }).then((assembly) => {\n      // Store the list of assemblies related to this upload.\n      const state = this.getPluginState()\n      const assemblyList = state.uploadsAssemblies[uploadID]\n      const uploadsAssemblies = Object.assign({}, state.uploadsAssemblies, {\n        [uploadID]: assemblyList.concat([ assembly.assembly_id ])\n      })\n\n      this.setPluginState({\n        assemblies: Object.assign(state.assemblies, {\n          [assembly.assembly_id]: assembly\n        }),\n        uploadsAssemblies\n      })\n\n      function attachAssemblyMetadata (file, assembly) {\n        // Attach meta parameters for the Tus plugin. See:\n        // https://github.com/tus/tusd/wiki/Uploading-to-Transloadit-using-tus#uploading-using-tus\n        // TODO Should this `meta` be moved to a `tus.meta` property instead?\n        const tlMeta = {\n          assembly_url: assembly.assembly_url,\n          filename: file.name,\n          fieldname: 'file'\n        }\n        const meta = Object.assign({}, file.meta, tlMeta)\n        // Add assembly-specific Tus endpoint.\n        const tus = Object.assign({}, file.tus, {\n          endpoint: assembly.tus_url,\n          // Only send assembly metadata to the tus endpoint.\n          metaFields: Object.keys(tlMeta),\n          // Make sure tus doesn't resume a previous upload.\n          uploadUrl: null,\n          // Disable tus-js-client fingerprinting, otherwise uploading the same file at different times\n          // will upload to the same assembly.\n          resume: false\n        })\n\n        // Set uppy server location.\n        // we only add this, if 'file' has the attribute remote, because\n        // this is the criteria to identify remote files. If we add it without\n        // the check, then the file automatically becomes a remote file.\n        // @TODO: this is quite hacky. Please fix this later\n        let remote\n        if (file.remote) {\n          let newHost = assembly.uppyserver_url\n          // remove tailing slash\n          if (newHost.endsWith('/')) {\n            newHost = newHost.slice(0, -1)\n          }\n          let path = file.remote.url.replace(file.remote.host, '')\n          // remove leading slash\n          if (path.startsWith('/')) {\n            path = path.slice(1)\n          }\n          remote = Object.assign({}, file.remote, {\n            host: newHost,\n            url: `${newHost}/${path}`\n          })\n        }\n\n        const transloadit = {\n          assembly: assembly.assembly_id\n        }\n\n        const newFile = Object.assign({}, file, { transloadit })\n        // Only configure the Tus plugin if we are uploading straight to Transloadit (the default).\n        if (!pluginOptions.importFromUploadURLs) {\n          Object.assign(newFile, { meta, tus, remote })\n        }\n        return newFile\n      }\n\n      const files = Object.assign({}, this.uppy.state.files)\n      fileIDs.forEach((id) => {\n        files[id] = attachAssemblyMetadata(files[id], assembly)\n      })\n\n      this.uppy.setState({ files })\n\n      this.uppy.emit('transloadit:assembly-created', assembly, fileIDs)\n\n      return this.connectSocket(assembly)\n        .then(() => assembly)\n    }).then((assembly) => {\n      this.uppy.log('[Transloadit] Created assembly')\n      return assembly\n    }).catch((err) => {\n      this.uppy.info(this.i18n('creatingAssemblyFailed'), 'error', 0)\n\n      // Reject the promise.\n      throw err\n    })\n  }\n\n  shouldWait () {\n    return this.opts.waitForEncoding || this.opts.waitForMetadata\n  }\n\n  /**\n   * Used when `importFromUploadURLs` is enabled: reserves all files in\n   * the assembly.\n   */\n  reserveFiles (assembly, fileIDs) {\n    return Promise.all(fileIDs.map((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      return this.client.reserveFile(assembly, file)\n    }))\n  }\n\n  /**\n   * Used when `importFromUploadURLs` is enabled: adds files to the assembly\n   * once they have been fully uploaded.\n   */\n  onFileUploadURLAvailable (fileID) {\n    const file = this.uppy.getFile(fileID)\n    if (!file || !file.transloadit || !file.transloadit.assembly) {\n      return\n    }\n\n    const state = this.getPluginState()\n    const assembly = state.assemblies[file.transloadit.assembly]\n\n    this.client.addFile(assembly, file).catch((err) => {\n      this.uppy.log(err)\n      this.uppy.emit('transloadit:import-error', assembly, file.id, err)\n    })\n  }\n\n  findFile (uploadedFile) {\n    const files = this.uppy.state.files\n    for (const id in files) {\n      if (!files.hasOwnProperty(id)) {\n        continue\n      }\n      // Completed file upload.\n      if (files[id].uploadURL === uploadedFile.tus_upload_url) {\n        return files[id]\n      }\n      // In-progress file upload.\n      if (files[id].tus && files[id].tus.uploadUrl === uploadedFile.tus_upload_url) {\n        return files[id]\n      }\n      if (!uploadedFile.is_tus_file) {\n        // Fingers-crossed check for non-tus uploads, eg imported from S3.\n        if (files[id].name === uploadedFile.name && files[id].size === uploadedFile.size) {\n          return files[id]\n        }\n      }\n    }\n  }\n\n  onFileUploadComplete (assemblyId, uploadedFile) {\n    const state = this.getPluginState()\n    const file = this.findFile(uploadedFile)\n    this.setPluginState({\n      files: Object.assign({}, state.files, {\n        [uploadedFile.id]: {\n          assembly: assemblyId,\n          id: file.id,\n          uploadedFile\n        }\n      })\n    })\n    this.uppy.emit('transloadit:upload', uploadedFile, this.getAssembly(assemblyId))\n  }\n\n  onResult (assemblyId, stepName, result) {\n    const state = this.getPluginState()\n    const file = state.files[result.original_id]\n    // The `file` may not exist if an import robot was used instead of a file upload.\n    result.localId = file ? file.id : null\n\n    const entry = {\n      result,\n      stepName,\n      id: result.id,\n      assembly: assemblyId\n    }\n\n    this.setPluginState({\n      results: [...state.results, entry]\n    })\n    this.uppy.emit('transloadit:result', stepName, result, this.getAssembly(assemblyId))\n  }\n\n  onAssemblyFinished (url) {\n    this.client.getAssemblyStatus(url).then((assembly) => {\n      const state = this.getPluginState()\n      this.setPluginState({\n        assemblies: Object.assign({}, state.assemblies, {\n          [assembly.assembly_id]: assembly\n        })\n      })\n      this.uppy.emit('transloadit:complete', assembly)\n    })\n  }\n\n  getPersistentData (setData) {\n    const state = this.getPluginState()\n    const assemblies = state.assemblies\n    const uploadsAssemblies = state.uploadsAssemblies\n    const uploads = Object.keys(state.files)\n    const results = state.results.map((result) => result.id)\n\n    setData({\n      [this.id]: {\n        assemblies,\n        uploadsAssemblies,\n        uploads,\n        results\n      }\n    })\n  }\n\n  /**\n   * Emit the necessary events that must have occured to get from the `prevState`,\n   * to the current state.\n   * For completed uploads, `transloadit:upload` is emitted.\n   * For new results, `transloadit:result` is emitted.\n   * For completed or errored assemblies, `transloadit:complete` or `transloadit:assembly-error` is emitted.\n   */\n  emitEventsDiff (prevState) {\n    const opts = this.opts\n    const state = this.getPluginState()\n\n    const emitMissedEvents = () => {\n      // Emit events for completed uploads and completed results\n      // that we've missed while we were away.\n      const newUploads = Object.keys(state.files).filter((fileID) => {\n        return !prevState.files.hasOwnProperty(fileID)\n      }).map((fileID) => state.files[fileID])\n      const newResults = state.results.filter((result) => {\n        return !prevState.results.some((prev) => prev.id === result.id)\n      })\n\n      this.uppy.log('[Transloadit] New fully uploaded files since restore:')\n      this.uppy.log(newUploads)\n      newUploads.forEach(({ assembly, uploadedFile }) => {\n        this.uppy.log(`[Transloadit]  emitting transloadit:upload ${uploadedFile.id}`)\n        this.uppy.emit('transloadit:upload', uploadedFile, this.getAssembly(assembly))\n      })\n      this.uppy.log('[Transloadit] New results since restore:')\n      this.uppy.log(newResults)\n      newResults.forEach(({ assembly, stepName, result, id }) => {\n        this.uppy.log(`[Transloadit]  emitting transloadit:result ${stepName}, ${id}`)\n        this.uppy.emit('transloadit:result', stepName, result, this.getAssembly(assembly))\n      })\n\n      const newAssemblies = state.assemblies\n      const previousAssemblies = prevState.assemblies\n      this.uppy.log('[Transloadit] Current assembly status after restore')\n      this.uppy.log(newAssemblies)\n      this.uppy.log('[Transloadit] Assembly status before restore')\n      this.uppy.log(previousAssemblies)\n      Object.keys(newAssemblies).forEach((assemblyId) => {\n        const oldAssembly = previousAssemblies[assemblyId]\n        diffAssemblyStatus(oldAssembly, newAssemblies[assemblyId])\n      })\n    }\n\n    // Emit events for assemblies that have completed or errored while we were away.\n    const diffAssemblyStatus = (prev, next) => {\n      this.uppy.log('[Transloadit] Diff assemblies')\n      this.uppy.log(prev)\n      this.uppy.log(next)\n\n      if (opts.waitForEncoding && next.ok === 'ASSEMBLY_COMPLETED' && prev.ok !== 'ASSEMBLY_COMPLETED') {\n        this.uppy.log(`[Transloadit]  Emitting transloadit:complete for ${next.assembly_id}`)\n        this.uppy.log(next)\n        this.uppy.emit('transloadit:complete', next)\n      } else if (opts.waitForMetadata && next.upload_meta_data_extracted && !prev.upload_meta_data_extracted) {\n        this.uppy.log(`[Transloadit]  Emitting transloadit:complete after metadata extraction for ${next.assembly_id}`)\n        this.uppy.log(next)\n        this.uppy.emit('transloadit:complete', next)\n      }\n\n      if (next.error && !prev.error) {\n        this.uppy.log(`[Transloadit]  !!! Emitting transloadit:assembly-error for ${next.assembly_id}`)\n        this.uppy.log(next)\n        this.uppy.emit('transloadit:assembly-error', next, new Error(next.message))\n      }\n    }\n\n    emitMissedEvents()\n  }\n\n  onRestored (pluginData) {\n    const savedState = pluginData && pluginData[this.id] ? pluginData[this.id] : {}\n    const knownUploads = savedState.files || []\n    const knownResults = savedState.results || []\n    const previousAssemblies = savedState.assemblies || {}\n    const uploadsAssemblies = savedState.uploadsAssemblies || {}\n\n    if (Object.keys(uploadsAssemblies).length === 0) {\n      // Nothing to restore.\n      return\n    }\n\n    // Fetch up-to-date assembly statuses.\n    const loadAssemblies = () => {\n      const assemblyIDs = []\n      Object.keys(uploadsAssemblies).forEach((uploadID) => {\n        assemblyIDs.push(...uploadsAssemblies[uploadID])\n      })\n\n      return Promise.all(\n        assemblyIDs.map((assemblyID) => {\n          const url = `https://api2.transloadit.com/assemblies/${assemblyID}`\n          return this.client.getAssemblyStatus(url)\n        })\n      )\n    }\n\n    const reconnectSockets = (assemblies) => {\n      return Promise.all(assemblies.map((assembly) => {\n        // No need to connect to the socket if the assembly has completed by now.\n        if (assembly.ok === 'ASSEMBLY_COMPLETE') {\n          return null\n        }\n        return this.connectSocket(assembly)\n      }))\n    }\n\n    // Convert loaded assembly statuses to a Transloadit plugin state object.\n    const restoreState = (assemblies) => {\n      const assembliesById = {}\n      const files = {}\n      const results = []\n      assemblies.forEach((assembly) => {\n        assembliesById[assembly.assembly_id] = assembly\n\n        assembly.uploads.forEach((uploadedFile) => {\n          const file = this.findFile(uploadedFile)\n          files[uploadedFile.id] = {\n            id: file.id,\n            assembly: assembly.assembly_id,\n            uploadedFile\n          }\n        })\n\n        const state = this.getPluginState()\n        Object.keys(assembly.results).forEach((stepName) => {\n          assembly.results[stepName].forEach((result) => {\n            const file = state.files[result.original_id]\n            result.localId = file ? file.id : null\n            results.push({\n              id: result.id,\n              result,\n              stepName,\n              assembly: assembly.assembly_id\n            })\n          })\n        })\n      })\n\n      this.setPluginState({\n        assemblies: assembliesById,\n        files: files,\n        results: results,\n        uploadsAssemblies: uploadsAssemblies\n      })\n    }\n\n    // Restore all assembly state.\n    this.restored = Promise.resolve()\n      .then(loadAssemblies)\n      .then((assemblies) => {\n        restoreState(assemblies)\n        return reconnectSockets(assemblies)\n      })\n      .then(() => {\n        // Return a callback that will be called by `afterUpload`\n        // once it has attached event listeners etc.\n        const newState = this.getPluginState()\n        const previousFiles = {}\n        knownUploads.forEach((id) => {\n          previousFiles[id] = newState.files[id]\n        })\n        return () => this.emitEventsDiff({\n          assemblies: previousAssemblies,\n          files: previousFiles,\n          results: newState.results.filter(({ id }) => knownResults.indexOf(id) !== -1),\n          uploadsAssemblies\n        })\n      })\n\n    this.restored.then(() => {\n      this.restored = null\n    })\n  }\n\n  connectSocket (assembly) {\n    const socket = new StatusSocket(\n      assembly.websocket_url,\n      assembly\n    )\n    this.sockets[assembly.assembly_id] = socket\n\n    socket.on('upload', this.onFileUploadComplete.bind(this, assembly.assembly_id))\n    socket.on('error', (error) => {\n      this.uppy.emit('transloadit:assembly-error', assembly, error)\n    })\n\n    socket.on('executing', () => {\n      this.uppy.emit('transloadit:assembly-executing', assembly)\n    })\n\n    if (this.opts.waitForEncoding) {\n      socket.on('result', this.onResult.bind(this, assembly.assembly_id))\n    }\n\n    if (this.opts.waitForEncoding) {\n      socket.on('finished', () => {\n        this.onAssemblyFinished(assembly.assembly_ssl_url)\n      })\n    } else if (this.opts.waitForMetadata) {\n      socket.on('metadata', () => {\n        this.onAssemblyFinished(assembly.assembly_ssl_url)\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      socket.on('connect', resolve)\n      socket.on('error', reject)\n    }).then(() => {\n      this.uppy.log('[Transloadit] Socket is ready')\n    })\n  }\n\n  prepareUpload (fileIDs, uploadID) {\n    // Only use files without errors\n    fileIDs = fileIDs.filter((file) => !file.error)\n\n    fileIDs.forEach((fileID) => {\n      this.uppy.emit('preprocess-progress', fileID, {\n        mode: 'indeterminate',\n        message: this.i18n('creatingAssembly')\n      })\n    })\n\n    const createAssembly = ({ fileIDs, options }) => {\n      return this.createAssembly(fileIDs, uploadID, options).then((assembly) => {\n        if (this.opts.importFromUploadURLs) {\n          return this.reserveFiles(assembly, fileIDs)\n        }\n      }).then(() => {\n        fileIDs.forEach((fileID) => {\n          this.uppy.emit('preprocess-complete', fileID)\n        })\n      })\n    }\n\n    const state = this.getPluginState()\n    const uploadsAssemblies = Object.assign({},\n      state.uploadsAssemblies,\n      { [uploadID]: [] })\n    this.setPluginState({ uploadsAssemblies })\n\n    let optionsPromise\n    if (fileIDs.length > 0) {\n      optionsPromise = this.getAssemblyOptions(fileIDs)\n        .then((allOptions) => this.dedupeAssemblyOptions(allOptions))\n    } else if (this.opts.alwaysRunAssembly) {\n      optionsPromise = Promise.resolve(\n        this.opts.getAssemblyOptions(null, this.opts)\n      ).then((options) => {\n        this.validateParams(options.params)\n        return [\n          { fileIDs, options }\n        ]\n      })\n    } else {\n      // If there are no files and we do not `alwaysRunAssembly`,\n      // don't do anything.\n      return Promise.resolve()\n    }\n\n    return optionsPromise.then((assemblies) => Promise.all(\n      assemblies.map(createAssembly)\n    ))\n  }\n\n  afterUpload (fileIDs, uploadID) {\n    // Only use files without errors\n    fileIDs = fileIDs.filter((file) => !file.error)\n\n    const state = this.getPluginState()\n\n    // If we're still restoring state, wait for that to be done.\n    if (this.restored) {\n      return this.restored.then((emitMissedEvents) => {\n        const promise = this.afterUpload(fileIDs, uploadID)\n        emitMissedEvents()\n        return promise\n      })\n    }\n\n    const assemblyIDs = state.uploadsAssemblies[uploadID]\n\n    // If we don't have to wait for encoding metadata or results, we can close\n    // the socket immediately and finish the upload.\n    if (!this.shouldWait()) {\n      assemblyIDs.forEach((assemblyID) => {\n        const socket = this.sockets[assemblyID]\n        socket.close()\n      })\n      const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\n      this.uppy.addResultData(uploadID, { transloadit: assemblies })\n      return Promise.resolve()\n    }\n\n    // If no assemblies were created for this upload, we also do not have to wait.\n    // There's also no sockets or anything to close, so just return immediately.\n    if (assemblyIDs.length === 0) {\n      this.uppy.addResultData(uploadID, { transloadit: [] })\n      return Promise.resolve()\n    }\n\n    let finishedAssemblies = 0\n\n    return new Promise((resolve, reject) => {\n      fileIDs.forEach((fileID) => {\n        this.uppy.emit('postprocess-progress', fileID, {\n          mode: 'indeterminate',\n          message: this.i18n('encoding')\n        })\n      })\n\n      const onAssemblyFinished = (assembly) => {\n        // An assembly for a different upload just finished. We can ignore it.\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\n          this.uppy.log(`[Transloadit] afterUpload(): Ignoring finished assembly ${assembly.assembly_id}`)\n          return\n        }\n        this.uppy.log(`[Transloadit] afterUpload(): Got assembly finish ${assembly.assembly_id}`)\n\n        // TODO set the `file.uploadURL` to a result?\n        // We will probably need an option here so the plugin user can tell us\n        // which result to pick…?\n\n        const files = this.getAssemblyFiles(assembly.assembly_id)\n        files.forEach((file) => {\n          this.uppy.emit('postprocess-complete', file.id)\n        })\n\n        checkAllComplete()\n      }\n\n      const onAssemblyError = (assembly, error) => {\n        // An assembly for a different upload just errored. We can ignore it.\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\n          this.uppy.log(`[Transloadit] afterUpload(): Ignoring errored assembly ${assembly.assembly_id}`)\n          return\n        }\n        this.uppy.log(`[Transloadit] afterUpload(): Got assembly error ${assembly.assembly_id}`)\n        this.uppy.log(error)\n\n        // Clear postprocessing state for all our files.\n        const files = this.getAssemblyFiles(assembly.assembly_id)\n        files.forEach((file) => {\n          // TODO Maybe make a postprocess-error event here?\n          this.uppy.emit('upload-error', file.id, error)\n\n          this.uppy.emit('postprocess-complete', file.id)\n        })\n\n        checkAllComplete()\n      }\n\n      const onImportError = (assembly, fileID, error) => {\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\n          return\n        }\n\n        // Not sure if we should be doing something when it's just one file failing.\n        // ATM, the only options are 1) ignoring or 2) failing the entire upload.\n        // I think failing the upload is better than silently ignoring.\n        // In the future we should maybe have a way to resolve uploads with some failures,\n        // like returning an object with `{ successful, failed }` uploads.\n        onAssemblyError(assembly, error)\n      }\n\n      const checkAllComplete = () => {\n        finishedAssemblies += 1\n        if (finishedAssemblies === assemblyIDs.length) {\n          // We're done, these listeners can be removed\n          removeListeners()\n          const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\n          this.uppy.addResultData(uploadID, { transloadit: assemblies })\n          resolve()\n        }\n      }\n\n      const removeListeners = () => {\n        this.uppy.off('transloadit:complete', onAssemblyFinished)\n        this.uppy.off('transloadit:assembly-error', onAssemblyError)\n        this.uppy.off('transloadit:import-error', onImportError)\n      }\n\n      this.uppy.on('transloadit:complete', onAssemblyFinished)\n      this.uppy.on('transloadit:assembly-error', onAssemblyError)\n      this.uppy.on('transloadit:import-error', onImportError)\n    }).then((result) => {\n      // Clean up uploadID → assemblyIDs, they're no longer going to be used anywhere.\n      const state = this.getPluginState()\n      const uploadsAssemblies = Object.assign({}, state.uploadsAssemblies)\n      delete uploadsAssemblies[uploadID]\n      this.setPluginState({ uploadsAssemblies })\n\n      return result\n    })\n  }\n\n  install () {\n    this.uppy.addPreProcessor(this.prepareUpload)\n    this.uppy.addPostProcessor(this.afterUpload)\n\n    if (this.opts.importFromUploadURLs) {\n      this.uppy.on('upload-success', this.onFileUploadURLAvailable)\n    }\n\n    this.uppy.on('restore:get-data', this.getPersistentData)\n    this.uppy.on('restored', this.onRestored)\n\n    this.setPluginState({\n      // Contains assembly status objects, indexed by their ID.\n      assemblies: {},\n      // Contains arrays of assembly IDs, indexed by the upload ID that they belong to.\n      uploadsAssemblies: {},\n      // Contains file data from Transloadit, indexed by their Transloadit-assigned ID.\n      files: {},\n      // Contains result data from Transloadit.\n      results: []\n    })\n  }\n\n  uninstall () {\n    this.uppy.removePreProcessor(this.prepareUpload)\n    this.uppy.removePostProcessor(this.afterUpload)\n\n    if (this.opts.importFromUploadURLs) {\n      this.uppy.off('upload-success', this.onFileUploadURLAvailable)\n    }\n  }\n\n  getAssembly (id) {\n    const state = this.getPluginState()\n    return state.assemblies[id]\n  }\n\n  getAssemblyFiles (assemblyID) {\n    const fileIDs = Object.keys(this.uppy.state.files)\n    return fileIDs.map((fileID) => {\n      return this.uppy.getFile(fileID)\n    }).filter((file) => {\n      return file && file.transloadit && file.transloadit.assembly === assemblyID\n    })\n  }\n}\n"]}